<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="./manifest.json" />
<title>ğŸ§¶ Jini Crochet</title>
<style>
  html, body {margin:0; padding:0; background:#fff; font-family:monospace; text-align:center;}
  #canvas {border:1px solid #ccc; margin:10px auto; display:block;}
  #svgOut {max-width:900px; margin:20px auto; display:block;}
  #saveBtn, #loadBtn {
    position:fixed; bottom:20px; padding:10px 16px; font-size:13px;
    color:#fff; border:none; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.2); cursor:pointer;
  }
  #saveBtn {right:20px; background:#16a34a;}
  #loadBtn {left:20px; background:#2563eb;}
  #credit {font-size:13px; color:#555; margin-top:10px;}
</style>
</head>
<body>

<h3>ğŸ§¶ Jini Crochet Pattern (App)</h3>
<div id="credit">âœ¨ï¸ì•± ì œì‘ : ì—°ìœ ì§„ğŸ§µ</div>

<input type="file" id="fileInput" accept="image/*" style="display:none;">
<button id="loadBtn">ğŸ–¼ï¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>

<canvas id="canvas"></canvas>

<!-- ğŸŒ êµ­ì œ í‘œì¤€ ëœ¨ê°œ ê¸°í˜¸ ì„¸íŠ¸ -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
  <defs id="symbolDefs">
    <symbol id="st-chain" viewBox="0 0 20 20">
      <circle cx="10" cy="10" r="6" stroke="#111" stroke-width="1.5" fill="none"/>
    </symbol>
    <symbol id="st-sc" viewBox="0 0 20 20">
      <path d="M10 2 V18" stroke="#111" stroke-width="1.5"/>
      <path d="M5 10 H15" stroke="#111" stroke-width="1.5"/>
    </symbol>
    <symbol id="st-dc" viewBox="0 0 20 20">
      <path d="M10 2 V18" stroke="#111" stroke-width="1.5"/>
      <path d="M7 6 L13 6" stroke="#111" stroke-width="1.2"/>
      <path d="M7 10 L13 10" stroke="#111" stroke-width="1.2"/>
      <path d="M7 14 L13 14" stroke="#111" stroke-width="1.2"/>
    </symbol>
    <symbol id="st-inc" viewBox="0 0 20 20">
      <path d="M5 18 L10 4 L15 18" stroke="#111" stroke-width="1.5" fill="none"/>
    </symbol>
    <symbol id="st-dec" viewBox="0 0 20 20">
      <path d="M5 4 L10 18 L15 4" stroke="#111" stroke-width="1.5" fill="none"/>
    </symbol>
    <symbol id="st-slst" viewBox="0 0 20 20">
      <circle cx="10" cy="10" r="2.5" stroke="#111" stroke-width="1.5" fill="none"/>
      <path d="M5 10 H15" stroke="#111" stroke-width="1.5"/>
    </symbol>
  </defs>
</svg>

<!-- ìŠ¤í‹°ì¹˜ ê¸°í˜¸ ì•ˆë‚´ -->
<div id="legend" style="max-width:700px;margin:20px auto;padding:12px;border:1px solid #ddd;border-radius:6px;text-align:left;font-size:14px;line-height:1.6;">
  <b>ğŸ§¶ ìŠ¤í‹°ì¹˜ ê¸°í˜¸ ì•ˆë‚´</b><br>
  <span style="color:#444;">X</span> â€” ì§§ì€ëœ¨ê¸° (Single Crochet)<br>
  <span style="color:#2b6cb0;">T</span> â€” í•œê¸¸ê¸´ëœ¨ê¸° (Double Crochet)<br>
  <span style="color:#2563eb;">â—‹</span> â€” ì‚¬ìŠ¬ëœ¨ê¸° (Chain Stitch)<br>
  <span style="color:#16a34a;">V</span> â€” ëŠ˜ë¦¼ (Increase)<br>
  <span style="color:#dc2626;">/\\</span> â€” ì¤„ì„ (Decrease)
</div>

<svg id="svgOut" xmlns="http://www.w3.org/2000/svg"></svg>
<button id="saveBtn">ğŸ’¾ ìë™ ì €ì¥</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker
    .register('./service-worker.js', { scope: './' })
    .then(() => console.log('ğŸ§¶ Service Worker registered!'))
    .catch(err => console.error('âŒ SW registration failed:', err));
}

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const svg=document.getElementById('svgOut');
const fileInput=document.getElementById('fileInput');
const loadBtn=document.getElementById('loadBtn');
const defs=document.getElementById('symbolDefs');

// íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
loadBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  handleImage(file);
};

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
canvas.ondragover=e=>{e.preventDefault();canvas.style.border='2px dashed #888';};
canvas.ondragleave=e=>{e.preventDefault();canvas.style.border='1px solid #ccc';};
canvas.ondrop=e=>{
  e.preventDefault();
  canvas.style.border='1px solid #ccc';
  const file=e.dataTransfer.files[0];
  if(!file)return;
  handleImage(file);
};

// ì´ë¯¸ì§€ ë¡œë“œ
function handleImage(file){
  const img=new Image();
  img.onload=()=>{
    canvas.width=img.width;
    canvas.height=img.height;
    svg.setAttribute("viewBox",`0 0 ${img.width} ${img.height}`);
    svg.setAttribute("width",img.width);
    svg.setAttribute("height",img.height);

    ctx.clearRect(0,0,img.width,img.height);
    ctx.drawImage(img,0,0,img.width,img.height);
    convertToPattern(img.width,img.height);
  };
  img.src=URL.createObjectURL(file);
}

// í”½ì…€â†’ê¸°í˜¸ ë³€í™˜
function convertToPattern(w,h){
  const imgData=ctx.getImageData(0,0,w,h);
  const data=imgData.data;
  let out="";
  for(let y=0;y<h;y+=20){
    for(let x=0;x<w;x+=20){
      const i=(y*w+x)*4;
      const avg=(data[i]+data[i+1]+data[i+2])/3;
      const sym=pickSymbol(avg);
      const symbolEl=defs.querySelector(`#${pickSymbolID(sym)}`);
      if(symbolEl){
        const clone=symbolEl.cloneNode(true);
        const inner=clone.innerHTML.replace(/stroke="#111"/g,`stroke="${pickColor(sym)}"`);
        out+=`<g transform="translate(${x},${y}) scale(1)">${inner}</g>`;
      }
    }
  }
  svg.innerHTML=`<rect width="${w}" height="${h}" fill="#fff" stroke="#ddd"/>`+out;
}

function pickSymbol(bright){
  if(bright<50)return"X";
  if(bright<90)return"T";
  if(bright<120)return"â—‹";
  if(bright<150)return"V";
  return"/\\";
}
function pickSymbolID(sym){
  switch(sym){
    case"X":return"st-sc";
    case"T":return"st-dc";
    case"â—‹":return"st-chain";
    case"V":return"st-inc";
    case"/\\":return"st-dec";
    default:return"st-slst";
  }
}
function pickColor(sym){
  switch(sym){
    case"X":return"#444";
    case"T":return"#2b6cb0";
    case"â—‹":return"#2563eb";
    case"V":return"#16a34a";
    case"/\\":return"#dc2626";
    default:return"#999";
  }
}

// ì €ì¥
document.getElementById('saveBtn').onclick=()=>{
  const name=prompt("ì €ì¥í•  íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: greenhair):");
  if(!name)return;

  const svgEl=document.getElementById('svgOut');
  const viewBox=svgEl.getAttribute('viewBox')||'0 0 800 800';
  const[, ,w,h]=viewBox.split(' ').map(Number);
  const svgData=svgEl.outerHTML;
  const imgSrc=canvas.toDataURL("image/png");

  const additions=`
    <image href="${imgSrc}" x="0" y="0" width="${w}" height="${h}" opacity="0.25"/>
    <text x="20" y="20" font-size="14" fill="#444">âœ¨ï¸ì•± ì œì‘ : ì—°ìœ ì§„ğŸ§µ</text>
    <g font-family="monospace" font-size="10" transform="translate(20,${h + 20})">
      <text fill="#000">ğŸ§¶ ìŠ¤í‹°ì¹˜ ê¸°í˜¸ ì•ˆë‚´</text>
      <text y="15" fill="#444">X â€” ì§§ì€ëœ¨ê¸° (Single Crochet)</text>
      <text y="30" fill="#2b6cb0">T â€” í•œê¸¸ê¸´ëœ¨ê¸° (Double Crochet)</text>
      <text y="45" fill="#2563eb">â—‹ â€” ì‚¬ìŠ¬ëœ¨ê¸° (Chain Stitch)</text>
      <text y="60" fill="#16a34a">V â€” ëŠ˜ë¦¼ (Increase)</text>
      <text y="75" fill="#dc2626">/\ â€” ì¤„ì„ (Decrease)</text>
    </g>
  `;

  const finalSvg=svgData.replace('</svg>',additions+'</svg>');
  const blob=new Blob([finalSvg],{type:'image/svg+xml;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');
  link.href=url;
  link.download=`${name}.svg`;
  link.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>