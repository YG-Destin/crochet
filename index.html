<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="./manifest.json" />
<title>🧶 Jini Crochet (App)</title>
<style>
  html, body {margin:0; padding:0; background:#fff; font-family:monospace; text-align:center;}
  #canvas {border:1px solid #ccc; margin:10px auto; display:block;}
  #svgOut {max-width:900px; margin:20px auto; display:block;}
  #saveBtn {
    position:fixed; bottom:20px; right:20px;
    background:#16a34a; color:#fff; border:none;
    padding:10px 16px; font-size:13px; border-radius:6px;
    box-shadow:0 2px 5px rgba(0,0,0,0.2); cursor:pointer;
  }
</style>
</head>
<body>

<h3>🧶 Jini Crochet Pattern (App)</h3>
<canvas id="canvas" width="800" height="800"></canvas>
<!-- 스티치 기호 안내 -->
<div id="legend" style="max-width:700px;margin:20px auto;padding:12px;border:1px solid #ddd;border-radius:6px;text-align:left;font-size:14px;line-height:1.6;">
  <b>🧶 스티치 기호 안내</b><br>
  <span style="color:#444;">X</span> — 짧은뜨기 (Single Crochet)<br>
  <span style="color:#2b6cb0;">T</span> — 한길긴뜨기 (Double Crochet)<br>
  <span style="color:#2563eb;">○</span> — 사슬뜨기 (Chain Stitch)<br>
  <span style="color:#16a34a;">V</span> — 늘림 (Increase)<br>
  <span style="color:#dc2626;">/\\</span> — 줄임 (Decrease)
</div>
<svg id="svgOut" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"></svg>
<button id="saveBtn">💾 자동 저장</button>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker
    .register('./service-worker.js', { scope: './' })
    .then(() => console.log('🧶 Service Worker registered!'))
    .catch(err => console.error('❌ SW registration failed:', err));
}

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const svg = document.getElementById('svgOut');

canvas.ondragover = e => { e.preventDefault(); canvas.style.border='2px dashed #888'; };
canvas.ondragleave = e => { e.preventDefault(); canvas.style.border='1px solid #ccc'; };
canvas.ondrop = e => {
  e.preventDefault();
  canvas.style.border='1px solid #ccc';
  const file = e.dataTransfer.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = () => {
    ctx.clearRect(0,0,800,800);
    ctx.drawImage(img,0,0,800,800);
    convertToPattern();
  };
  img.src = URL.createObjectURL(file);
};

function convertToPattern(){
  const imgData = ctx.getImageData(0,0,800,800);
  const data = imgData.data;
  let path="";
  for(let y=0; y<800; y+=20){
    for(let x=0; x<800; x+=20){
      const i = (y*800 + x)*4;
      const avg = (data[i]+data[i+1]+data[i+2])/3;
      const sym = pickSymbol(avg);
      path += `<text x="${x}" y="${y}" font-size="8" fill="${pickColor(sym)}">${sym}</text>`;
    }
  }
  svg.innerHTML = `<rect width="800" height="800" fill="#fff" stroke="#ddd"/>` + path;
}

function pickSymbol(bright){
  if(bright<50) return "X";
  if(bright<90) return "T";
  if(bright<120) return "○";
  if(bright<150) return "V";
  return "/\\";
}
function pickColor(symbol){
  switch(symbol){
    case 'X': return "#444";
    case 'T': return "#2b6cb0";
    case '○': return "#2563eb";
    case 'V': return "#16a34a";
    case '/\\': return "#dc2626";
    default: return "#999";
  }
}

document.getElementById('saveBtn').onclick = () => {
  const name = prompt("저장할 파일 이름을 입력하세요 (예: greenhair):");
  if (!name) return;
  const svgData = document.getElementById('svgOut').outerHTML;
  const blob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${name}.svg`;
  link.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>